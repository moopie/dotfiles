#!/usr/bin/env sh

#
# Livestreaming with FFMPEG for Twitch.tv
#

main() {
    local STREAM_KEY=$(cat $HOME/.twitchkey)

    if [ -z $STREAM_KEY ]; then
        echo "Please place your twitch.tv stream key into $HOME/.twitchkey"
        echo "You can get your stream key from http://www.twitch.tv/broadcast/dashboard/streamkey"
        exit 1
    fi

    local URL="rtmp://live.twitch.tv/app/$STREAM_KEY"
    local INRES="1920x1080"
    #local OUTRES="1920x1080"
    #local OUTRES="1280x720"
    local OUTRES="854x480"
    local FPS="30"
    local QUAL="medium"

    # -f x11grab       forces input to be from x11grab
    # -s "$INRES"      sets a specific image size, relying on the variable $INRES
    # -r "$FPS"        sets framerate to be the value equal to $FPS
    # -i :0.0          gets input, in this case its pulling in screen :0.0 from x11
    #                  for multi-monitor setup add the location of the screen you want to stream
    #                  for example, on two 1080p monitors, to stream on the second one use ":0.0+1920,0"
    # -f alsa          forces audio input to be from alsa
    # -ac 2            sets audio channels to 2
    # -i pulse         gets input from pulse
    # -c:v libx264     sets video codec to libx264
    # -crf 23          sets the ffmpeg constant rate factor to 23 (the default)
    # -preset "$QUAL"  sets the preset compression quality and speed. possible presets are:
    #                      ultrafast    superfast   veryfast
    #                      faster       fast        medium
    #                      slow         slower      veryslow
    # -s "$OUTRES"     specifies size of image
    # -c:a libmp3lame  sets audio codec to use libmp3lame
    # -q:a 4           sets audio quality to 4 which is a bitrate range of 140-185
    #                  use -b:a <bitrate> for a constant rate
    # -threads 0       sets cpu threads to start, 0 autostarts threads based on cpu cores
    # -pix_fmt yuv420p sets pixel format to Y'UV420p. Otherwise by default Y'UV444 is used and is incompatible with twitch
    # -f flv "$URL"    forces format to flv, and outputs to the twitch RTMP url 

    ffmpeg -f x11grab -s "$INRES" -r "$FPS" -i :0.0 \
        -f alsa -ac 2 -i pulse \
        -c:v libx264 -crf 23 -preset "$QUAL" -s "$OUTRES" \
        -c:a libmp3lame -q:a 4 -ar 44100 -threads 0 -pix_fmt yuv420p \
        -f flv "$URL" \
        &> $HOME/.twitch.log
}

# Run the script
main
